---
title: "Lego Trends throughout the Years"
author: "Adrian Cariaga"
date: "January 11 2022"
output:
  html_document: default
  pdf_document: default
---

# Lego Trends throughout the Years

* We will take a look at various data about Lego sets.  We will see trends in quantity of parts, 
  themes and colors throughout the decades.

## Set up the environment

* We will install packages and libraries for data cleaning, transformation and visualization

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=TRUE}
install.packages("ggplot2", repos = "http://cran.us.r-project.org")
install.packages("readr", repos = "http://cran.us.r-project.org")
install.packages("tidyverse", repos = "http://cran.us.r-project.org")
install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")
install.packages("ggrepel", repos = "http://cran.us.r-project.org")
install.packages("treemap", repos = "http://cran.us.r-project.org")
install.packages("packcircles", repos = "http://cran.us.r-project.org")
```

```{r, echo=FALSE}
library(ggplot2)
library(readr)
library(tidyverse)
library(RColorBrewer)
library(ggrepel)
library(treemap)
library(packcircles)
options(warn = 1, message = 1)
```

## The following data will be used for cleaning, transformation and visualization

```{r echo=FALSE}
getwd()
setwd("D:/Files/Stuff/Important papers/Personal PC projects/Portfolio/R Markdown/Lego dataset")

```


```{r echo=TRUE}
colors <- read.csv("colors.csv")
sets <- read.csv("sets.csv")
parts <- read.csv("parts.csv")
inventory_sets <- read.csv("inventory_sets.csv")
inventory <- read.csv("inventories.csv")
inventory_parts <- read.csv("inventory_parts.csv")
themes <- read.csv("themes.csv")
part_category <- read.csv("part_categories.csv")
```

## We will check number of unique colors

```{r echo=FALSE}
num_colors <- length(unique(colors$colorName))
paste("Number of Unique colors in Lego sets =", num_colors)
colors <- colors%>%mutate(rgb=paste0("#",str_trim(rgb)))
my_color <- colors$rgb
names(my_color)<-my_color
```
## We will look at data from Sets

* Average Parts per Year from 1950 to 2020

```{r echo=FALSE}
options(repr.plot.width = 6, repr.plot.height = 3)
part_year = sets %>%
  select(year,num_parts) %>%
  group_by(year )%>%
  summarize(avg_parts=mean(num_parts))
part_year %>%
  ggplot(aes(x=year, y=avg_parts,group=1)) + geom_line(size=0.5) + geom_point(color='blue',size=0.5) + labs(title='Average Parts per Year')
```
* The following shows Lego themes released per Year

```{r echo=FALSE}
sets %>%
  select(year,theme_id) %>%
  group_by(year) %>%
  summarize(theme_count=length(unique(theme_id))) %>%
  ggplot(aes(x=year,y=theme_count)) +
  geom_line()+geom_point(color='red',size=0.5)+labs(title='Themes Released per Year')
```
## The following data will highlight Lego parts

* We will look at the data structure of the "part_category" data

```{r echo=FALSE}
str(part_category)
colnames(part_category)[2] <- "part_category_name"
colnames(parts)[2] <- "part_name"
colnames(colors)[2] <- "color_name"
part_cat <- part_category%>%
  left_join(parts,by=c('id'='part_cat_id'))
head(part_cat)
```
* The following is a comparison of parts under a category within the Lego family

```{r echo=FALSE}
options(repr.plot.width=6, repr.plot.height = 7)
part_cat%>%
  select(part_category_name,part_num)%>%
  group_by(part_category_name)%>%
  summarize(parts_under_cat=length(unique(part_num)))%>%
  arrange(desc(parts_under_cat))%>%
  ggplot(aes(x=reorder(part_category_name,parts_under_cat),y=parts_under_cat,fill=part_category_name))+geom_bar(stat='identity')+coord_flip()+
  scale_fill_manual(values=colors$rgb)+theme(legend.position='none')+
  labs(title='Parts under Category',x='Category',y="No. of Parts")
```
* The following data will take an in depth look at Lego parts

```{r echo=FALSE}
options(warn = -1)
part_color <- part_cat%>%left_join(inventory_parts,by='part_num')%>%
  left_join(colors,by=c('color_id'='id'))

partsp_col <- part_color%>%select(color_name,rgb,part_name)%>%group_by(color_name,rgb)%>%summarize(part_per_color=length(unique(part_name)))%>%
  arrange(desc(part_per_color))%>%head(100)

head(part_color)
```
* Now that we have set up a data frame for part colors, we will take a look at parts and colors used
* This chart will show number of unique parts per color

```{r echo=FALSE}
options(repr.plot.width = 5, repr.plot.height = 4)
partsp_col%>% head(20)%>% filter(!color_name %in% c("[No Color]","NA"))%>% filter(!is.na(color_name))%>%
  ggplot(aes(x=reorder(color_name,part_per_color),y=part_per_color,fill=rgb))+geom_bar(stat='identity')+
  scale_fill_manual(values=my_color)+theme(legend.position='none',axis.text.x=element_text(angle=90))+
  labs(title='Top Unique Parts per Color',x='color',y='Parts')
```
* This chart will show Lego sets with the maximum number of parts

```{r echo=FALSE}
options(repr.plot.width=10, repr.plot.height=4)
colnames(themes)[2]<-'theme_name'
colnames(sets)[2]<-'set_name'
themes<-themes[,-3]
set_themes<-themes%>%left_join(sets,by=c('id'='theme_id'))
set_themes%>%group_by(set_name)%>%summarize(parts_count=sum(num_parts))%>%arrange(desc(parts_count))%>%
  head(25)%>%ggplot(aes(x=reorder(set_name,parts_count),y=parts_count,fill=set_name,group=1))+geom_line(stat='identity')+
  geom_point()+scale_color_manual(values=names(my_color))+geom_label_repel(aes(label=set_name),size=2)+
  theme(legend.position='none',axis.text.x=element_blank())+labs(title='Lego Sets with Maximum Parts- Top 25',x='Set')
```
## We will now look at Lego themes and any data associated with it

* The following chart will show set counts in Lego themes

```{r echo=FALSE}
options(repr.plot.width = 15, repr.plot.height = 8)

themes_per_set<-set_themes%>%select(theme_name,set_num)%>%group_by(theme_name)%>%summarize(set_cnt=length(unique(set_num)))%>%
  arrange(desc(set_cnt))%>%head(50)
treemap(themes_per_set,
        index='theme_name',
        vSize = 'set_cnt',
        type = 'index',
      fontsize.labels = 7,
      palette=(default="HCL"), 
        title='Lego Themes Based on Set Counts'
)
```
* The following is another way of looking at the top Lego themes

```{r echo=FALSE}
options(repr.plot.width = 5, repr.plot.height = 4)
themes_per_set%>%head(15)%>%ggplot(aes(x=reorder(theme_name,set_cnt), set_cnt,fill=theme_name))+
  geom_bar(stat='identity')+coord_flip()+
  theme(legend.position = 'none')+labs(x='Theme',y='sets',title='Top Lego Themes based on Set Count')
```
* We will look at two charts on popular lego themes throughout the years

```{r echo=FALSE}
options(repr.plot.width = 7, repr.plot.height = 4)
set_themes %>% 
  filter(theme_name %in% c('Star Wars', 'City', 'Space', 'Vikings', 'Studios', 'Super Heroes', 'The Lego Movie', 'The Lord of the Rings'
                                        ,'Ninjago', 'Toy Story')) %>% 
  group_by(year,theme_name) %>% 
  summarize(set=length(unique(set_name))) %>% 
  ggplot(aes(x=year, y=set, fill=theme_name))+geom_bar(stat='identity')+labs(title='Popular Lego Themes from 1950')
```
```{r echo=FALSE}
options(repr.plot.width = 15, repr.plot.height = 8)
the_set <- set_themes %>% 
  filter(theme_name %in% c('Star Wars', 'City', 'Space', 'Vikings', 'Studios'
                           , 'Super Heroes', 'The LEGO Movie', 'The Lord of the Rings', 'Ninjago'
                           , 'Toy Story')) %>% 
  filter(num_parts>70)

treemap(the_set, index=c('theme_name', 'set_name'), vSize = 'num_parts', type='index',
        
        fontsize.labels = c(15,12),
        fontcolor.labels = c('white','black'),
        fontface.labels = c(2,1),
        bg.labels = c('transparent'),
        align.labels = list(
          c('center', 'center'),
          c('right', 'bottom')
        ),
        inflate.labels = F,
        title = "Popular Lego themes and its Sets")
```
## We will now look at data on colors used for Lego parts

* First, we will organize and transform data on colors

```{r echo=FALSE}
options(warn = -1)
options(repr.plot.width = 15, repr.plot.height = 10)
set_color <- sets %>% 
  left_join(inventory, by='set_num') %>% 
  left_join(inventory_parts, by=c('id'='inventory_id')) %>% 
  left_join(colors,by=c('color_id'='id'))

this_year<-format(Sys.Date(),'%Y')
cyear<-as.numeric(this_year)

scolor<-set_color %>% 
  select(color_name,rgb,year) %>% 
  mutate(ys=cyear-year)

color_years<-scolor %>% 
  select(color_name,ys,year,rgb) %>% 
  group_by(color_name,rgb) %>% 
  summarize(mx_year=max(ys),mn_year=min(year)) %>% 
  arrange(desc(mx_year)) %>% 
  filter(!is.na(rgb)) %>% 
  filter(mx_year>=40 & !color_name=="[No Color]")

label_data<-data.frame(id=seq(1:nrow(color_years)),
                       lbl=paste(color_years$color_name,color_years$mx_year,'Years'),
                       value=color_years$mx_year)
```
* The following is a visualization of Lego colors used over 40 years

```{r echo=FALSE}
no_bars<-nrow(label_data)
cl<-color_years %>% 
  filter(!is.na(rgb)) %>% 
  filter(!color_name=='[No Color]') %>% 
  select(rgb)
cl<-cl$rgb
names(cl)<-cl

angle=90-360*(label_data$id-0.5)/no_bars
label_data$hjust<-ifelse(angle< -90, 1, 0)
label_data$angle<-ifelse(angle< -90, angle+180, angle)
ggplot(color_years,aes(x=color_name, y=mx_year,fill=color_name))+geom_bar(stat='identity')+
  scale_fill_manual(values = names(cl))+ylim(-60,90)+coord_polar(start=0)+
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
      legend.position = 'none',legend.text= element_text(size=7))+
  geom_text(data=label_data,aes(x=id, y=value+10, label=lbl, hjust=hjust), color='black',
            fontface='bold', alpha=0.6, size=3, angle=label_data$angle, inherit.aes=FALSE)+
  labs(title="Lego Colors and its Years > 40")
```


* Popular Lego colors in their sets


```{r echo=FALSE}
set_max_color<- set_color %>% 
  group_by(color_name,rgb) %>% 
  summarize(dcnt=length(unique(set_name))) %>% 
  arrange(desc(dcnt)) %>% head(50)

data <- data.frame(grp=paste(set_max_color$color_name,'\n ', set_max_color$dcnt), value=set_max_color$dcnt)
packing <- circleProgressiveLayout(data$value, sizetype = 'area')
data <- cbind(data, packing)
dat.gg <- circleLayoutVertices(packing, npoints=100)

ggplot()+
  geom_polygon(data= dat.gg, aes(x, y, group= id, fill=as.factor(id)))+
  scale_fill_manual(values= set_max_color$rgb)+
  geom_text(data=data, aes(x, y, size= value, label= grp))+
  scale_size_continuous(range= c(1,4))+
  theme_void()+theme(legend.position = 'none')+labs(title= "Popular Lego Colors in their Sets")+coord_equal()
```


* This is a historical context of the count of Lego colors all the way from 1950


```{r echo=FALSE}
set_color %>% 
  select(year, color_name, rgb) %>% 
  group_by(year, color_name, rgb) %>% 
  summarize(col_cnt=n()) %>% 
  arrange(desc(col_cnt)) %>% 
  ggplot(aes(x=year, y=col_cnt, fill= rgb))+ geom_point(shape=21, size=3)+ 
  theme(legend.position = 'none')+labs(title= "Lego Colors counted from 1958", y='')
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
